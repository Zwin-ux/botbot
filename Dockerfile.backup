FROM alpine:latest

# Install required packages
RUN apk add --no-cache \
    bash \
    curl \
    sqlite \
    aws-cli \
    dcron \
    rsync \
    gzip \
    tar

# Create backup user
RUN addgroup -g 1001 -S backup && \
    adduser -S backup -u 1001 -G backup

# Set working directory
WORKDIR /app

# Copy backup scripts
COPY scripts/backup.sh /app/backup.sh
COPY scripts/restore.sh /app/restore.sh

# Make scripts executable
RUN chmod +x /app/backup.sh /app/restore.sh

# Create necessary directories
RUN mkdir -p /app/data /app/backups /var/log/cron && \
    chown -R backup:backup /app /var/log/cron

# Switch to backup user
USER backup

# Set up cron job
RUN echo "${BACKUP_SCHEDULE:-0 2 * * *} /app/backup.sh >> /var/log/cron/backup.log 2>&1" | crontab -

# Start cron daemon
CMD ["crond", "-f", "-d", "8"]